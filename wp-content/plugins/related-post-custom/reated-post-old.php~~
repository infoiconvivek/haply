<?php
/*
Plugin Name: Custom Related Posts for epkb_post_type_1
Description: Allows selection of related posts with category filtering for epkb_post_type_1 custom post type.
Version: 1.0
Author: Your Name
*/

// Enqueue scripts and styles for Select2 and custom CSS
function custom_related_posts_enqueue_scripts()
{
    // Enqueue Select2 library
    wp_enqueue_script('select2', 'https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js', array('jquery'), '4.0.13', true);
    wp_enqueue_style('select2', 'https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css', array(), '4.0.13');

    // Enqueue custom CSS file
    wp_enqueue_style('custom-related-posts-css', plugins_url('css/custom-related-posts.css', __FILE__), array(), '1.0');
}
add_action('admin_enqueue_scripts', 'custom_related_posts_enqueue_scripts');

// Add meta box to custom post type editor screen
function custom_related_posts_meta_box()
{
    add_meta_box(
        'custom_related_posts_meta_box',
        'Related Posts',
        'custom_related_posts_meta_box_content',
        'epkb_post_type_1', // Specify your custom post type slug here
        'normal',
        'default'
    );
}
add_action('add_meta_boxes', 'custom_related_posts_meta_box');

// Callback function to display meta box content
function custom_related_posts_meta_box_content($post)
{
    // Get saved related posts

    $related_posts = get_post_meta($post->ID, '_related_posts', true) ? get_post_meta($post->ID, '_related_posts', true) : [];
?>
    <label for="related_posts">Select Related Posts:</label><br>
    <select name="related_posts[]" id="related_posts" multiple="multiple" style="width: 100%;">
        <?php
        // Get all categories
        // $categories = get_categories();

        $args = array(
            'orderby' => 'name',
            'order' => 'asc',
        );

        $terms = get_terms('epkb_post_type_1_category', $args);

        // print_r($terms);
        //foreach ($terms as $category) {
        // echo '<optgroup label="' . esc_attr($category->name) . '">';
        // Get posts by category
        $manage_theme = get_field('manage_theme'); // Retrieve the manage_theme value dynamically

        $meta_query = array();

        // Check if both values in $manage_theme exist
        if (isset($manage_theme[0]) && isset($manage_theme[1])) {
            $meta_query['relation'] = 'OR';

            // Add the first value to the meta query
            $meta_query[] = array(
                'key'     => 'manage_theme',
                'value'   => $manage_theme[0],
                'compare' => 'like'
            );

            // Add the second value to the meta query
            $meta_query[] = array(
                'key'     => 'manage_theme',
                'value'   => $manage_theme[1],
                'compare' => 'like'
            );
        } elseif (isset($manage_theme[0])) {
            // If only the first value exists, apply a meta query for that value
            $meta_query = array(
                array(
                    'key'     => 'manage_theme',
                    'value'   => $manage_theme[0],
                    'compare' => 'like'
                )
            );
        }

        $posts = get_posts(
            array(
                'post_type'      => 'epkb_post_type_1',
                'posts_per_page' => -1,
                'meta_query'     => $meta_query,
            )
        );
        foreach ($posts as $p) {
            $selected = in_array($p->ID, $related_posts) ? 'selected="selected"' : '';
            echo '<option value="' . esc_attr($p->ID) . '" ' . $selected . '>' . esc_html($p->post_title) . '</option>';
        }
        // echo '</optgroup>';
        // }
        ?>
    </select>
    <script>
        jQuery(document).ready(function($) {
            $('#related_posts').select2({
                placeholder: 'Select related posts',
                allowClear: true
            });
        });
    </script>
<?php
}

// Save related posts when custom post type is saved
function save_custom_related_posts($post_id)
{
    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
    if (!current_user_can('edit_post', $post_id)) return;
    if (isset($_POST['related_posts'])) {
        $related_posts = array_map('intval', $_POST['related_posts']);
        update_post_meta($post_id, '_related_posts', $related_posts);
    } else {
        delete_post_meta($post_id, '_related_posts');
    }
}
add_action('save_post_epkb_post_type_1', 'save_custom_related_posts');

// Display related posts in admin area for custom post type
function display_custom_related_posts()
{
    global $post;
    if ($post->post_type === 'epkb_post_type_1') {
        $related_posts = get_post_meta($post->ID, '_related_posts', true);
        if (!empty($related_posts)) {
            echo '<h3>Related Posts</h3>';
            echo '<ul>';
            foreach ($related_posts as $related_post_id) {
                $related_post = get_post($related_post_id);
                if ($related_post) {
                    echo '<li><a href="' . esc_url(get_edit_post_link($related_post_id)) . '">' . esc_html($related_post->post_title) . '</a></li>';
                }
            }
            echo '</ul>';
        }
    }
}
add_action('edit_form_after_title', 'display_custom_related_posts');
